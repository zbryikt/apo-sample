{"_type":{"location":"server","name":"chart"},"owner":4,"key":1074,"permission":{"value":[{"perm":"fork","switch":"public"}],"switch":["public"]},"name":"Weekly Calendar Heatmap","theme":null,"parent":null,"description":"github style, daily heatmap grouped by week. non-responsive version, show at most 365 days.","basetype":["11"],"visualencoding":["10"],"category":["1","5"],"tags":["github","calendar","heatmap","gradient","contribution","performance","sales","visit","traffic","daily"],"likes":0,"searchable":true,"doc":{"name":"document","size":86,"type":"html","lines":4,"content":"<div class=\"pdb-popup\">\n  <div class=\"title\"></div>\n  <div class=\"value\"></div>\n</div>"},"style":{"name":"stylesheet","size":0,"type":"css","lines":1,"content":""},"code":{"name":"code","size":7935,"type":"javascript","lines":207,"content":"var module = {};\nmodule.exports = plotdb.chart.create({\n  sample: function() {\n    var date = [{name: \"date\", data: d3.range(360).map(function(d,i) { \n      return new Date(new Date().getTime() - d * 86400000);\n    })}];\n    var value = [{name: \"value\", data: d3.range(360).map(function(d,i) { return Math.random(); })}];\n    return {value: value, date: date};\n  },\n  dimension: {\n    value: { type: [plotdb.Number], require: true, desc: \"color\" },\n    date: { type: [plotdb.Date], require: true, desc: \"date\" }\n  },\n  config: {\n    padding: { name: \"Padding\", type: [plotdb.Number], default: 10 },\n    margin: { name: \"Margin\", type: [plotdb.Number], default: 10 },\n    fontSize: { name: \"Font Size\", type: [plotdb.Number], default: 12 },\n    color: { name: \"Color\", type: [plotdb.Color], default: plotdb.Color.default },\n    today: { name: \"from Today\", type: [plotdb.Boolean], default: true, rebindOnChange: true},\n    empty: { name: \"empty as 0\", type: [plotdb.Boolean], default: true}\n  },\n  init: function() {\n    var that = this;\n    var now = new Date();\n    this.lastweek = parseInt((now.getTime() - now.getDay() * 86400000 ) / ( 7 * 86400000));\n    this.svg = d3.select(this.root).append(\"svg\");\n    this.popup = d3.select(this.root).select(\".pdb-popup\");\n    this.datagroup = this.svg.append(\"g\").attr({class: \"data-group\"});\n    this.yAxisGroup = this.svg.append(\"g\").attr({class: \"axis vertical\"});\n    this.xAxisGroup = this.svg.append(\"g\").attr({class: \"axis horizontal\"});\n    var datehash = {};\n    var origin = new Date(\"1970/01/01\").getTime();\n    this.data.map(function(d,i) {\n      d.dateobj = new Date(d.date);\n      d.day = d.dateobj.getDay();\n      d.time = d.dateobj.getTime() - origin;\n      d.time = d.time - (d.time % 86400 * 1000);\n      d.key = parseInt(d.time / (86400 * 1000));\n      if(datehash[d.key]) datehash[d.key].value += d.value;\n      else datehash[d.key] = d;\n    });\n    this.data.sort(function(a,b) { return b.time - a.time; });\n    var latest = ((this.config.today?new Date().getTime():this.data[0].dateobj.getTime()));\n    var latest = latest - (latest % 86400000);\n    var datelist = d3.range(365).map(function(d) { \n      var key = parseInt((latest - 86400 * 1000 * d) / ( 86400 * 1000));\n      var ret = datehash[key];\n      var date = new Date(key * 86400 * 1000);\n      if(ret) {\n        ret.day = date.getDay();\n        return ret;\n      }\n      return {\n        dateobj: new Date(key * 86400 * 1000),\n        day: date.getDay(),\n        time: date.getTime(),\n        key: key,\n        value: undefined\n      };\n    });\n    this.data = datelist;\n    if(this.data.length > 365) this.data.splice(365, this.data.length);\n    this.weeklabel = [\"M\",\"W\",\"F\"].map(function(d,i) { return {key: d, day: (i+1) };});\n    this.monthlabel = [];\n    var months = [\"JAN\",\"FEB\",\"MAR\",\"APR\",\"MAY\",\"JUN\",\"JUL\",\"AUG\",\"SEP\",\"OCT\",\"NOV\",\"DEC\"];\n    var year = new Date().getYear(), month = new Date().getMonth();\n    for(var i = 0,d,week; i < 12; i++) {\n      d = new Date(year+1900,month,1);\n      week = this.lastweek - parseInt((d.getTime() - d.getDay() * 86400000 ) / ( 7 * 86400000));\n      this.monthlabel.push({date: d, week: week, key:months[month]});\n      month -= 1;\n      if(month < 0) { month = 11; year -= 1; }\n    }\n    this.weeks = d3.map(this.data, function(d) {\n      return that.lastweek - parseInt((d.dateobj.getTime() - d.dateobj.getDay() * 86400000) / ( 7 * 86400000));\n    }).keys().map(function(d,i) { return parseInt(d); });\n    this.data.map(function(d,i) {\n      d.week = that.lastweek - parseInt((d.dateobj.getTime() - d.dateobj.getDay() * 86400000) / ( 7 * 86400000));\n    });\n    this.valuerange = d3.extent(this.data.map(function(d,i) { return d.value; }));\n  },\n  pad: function(v,len) {\n    var clen = (v+\"\").length;\n    var ret = v+\"\";\n    if(clen < len) for(var i=0;i<len - clen;i++) ret = \"0\" + ret;\n    return ret;\n  },\n  bind: function() {\n    var that = this;\n    this.xAxisGroup.selectAll(\"g.tick\").data(this.monthlabel)\n    .enter().append(\"g\").attr({class: \"tick\"}).each(function(d,i) {\n      d3.select(this).append(\"text\").text(d.key);\n    });\n    this.yAxisGroup.selectAll(\"g.tick\").data(this.weeklabel)\n    .enter().append(\"g\").attr({class: \"tick\"}).each(function(d,i) {\n      d3.select(this).append(\"text\").text(d.key);\n    });\n    this.datagroup.selectAll(\"rect.data\").data(this.data)\n    .enter().append(\"rect\").attr({class: \"data\"})\n    .on(\"mouseout\",function(d,i) {\n      that.popup.style({display: \"none\"});\n    }).on(\"mousemove\",function(d,i) {\n      var x = d3.event.clientX;\n      var y = d3.event.clientY;\n      that.popup.style({display: \"block\"});\n      var date = [\n        (d.dateobj.getYear() + 1900),\n        that.pad(d.dateobj.getMonth() + 1, 2),\n        that.pad(d.dateobj.getDate(), 2)\n      ].join(\"/\");\n      that.popup.select(\".title\").text(date).style({margin: 0});\n      that.popup.select(\".value\").text(parseInt(100*(d.value || 0))/100);\n      setTimeout(function() {\n      var pbox = that.popup[0][0].getBoundingClientRect();\n      var isleft = ( x < that.width / 2 );\n      if(!isleft) x = x - pbox.width - that.size * 2;\n      else x = x + that.size * 2;\n      y = y - pbox.height / 2;\n      that.popup.attr({\n        class: \"pdb-popup \" + (isleft ? \"right\":\"left\")\n      }).style({\n        display: \"block\",\n        top: y + \"px\",\n        left: x + \"px\"\n      });\n      }, 0);\n    });\n  },\n  resize: function() {\n    var that = this;\n    var box = this.root.getBoundingClientRect();\n    var width = this.width = box.width;\n    var height = this.height = box.height - 10;\n    this.svg.attr({\n      width: width + \"px\", height: height + \"px\",\n      viewBox: [0,0,width,height].join(\" \"),\n      preserveAspectRatio: \"xMidYMid\"\n    });\n    this.popup.style({\"font-size\": that.config.fontSize + \"px\"});\n    this.size = that.config.fontSize;\n    this.yscale = d3.scale.ordinal().domain(d3.range(7))\n      .rangeBands([10, 100],0.1,0.1);\n    this.xscale = d3.scale.ordinal().domain(this.weeks)\n      .rangeBands([\n        that.width / 2 + (that.weeks.length * (that.size + that.config.padding) / 2),\n        that.width / 2 - (that.weeks.length * (that.size + that.config.padding) / 2),\n\n      ], 0.1, 0.1);\n    this.cscale = d3.scale.linear().domain([0, this.valuerange[1]]).range([\"#eee\", that.config.color]);\n  },\n  render: function() {\n    var that = this;\n    var offset = [\n      \"translate(\",\n      0,\n      (that.height / 2 - that.size * 3 - that.config.padding * 3.5),\n      \")\"\n    ].join(\" \");\n    this.xAxisGroup\n    .attr({ transform: offset })\n    .selectAll(\"g.tick\").attr({\n      transform: function(d,i) {\n        return [\n          \"translate(\",\n          that.xscale(d.week) + that.size/2,\n          -that.size / 1.5,\n          \")\"].join(\" \");\n      },\n      opacity: function(d,i) {\n        return (isNaN(that.xscale(d.week)) ? 0 : 1);\n      }\n    });\n    this.yAxisGroup\n    .attr({ transform: offset })\n    .selectAll(\"g.tick\").attr({\n      transform: function(d,i) {\n        return [\n          \"translate(\",\n          that.xscale(that.weeks[that.weeks.length - 1]) -that.size / 1.5,\n          d.day * 2 * (that.size + that.config.padding) - that.size * 0.5,\n          \")\"\n        ].join(\" \");\n      }\n    });\n    this.svg.selectAll(\".axis .tick text\").attr({\n      \"text-anchor\": \"middle\",\n      \"dominant-baseline\": \"middle\",\n      \"font-size\": that.size,\n      \"font-family\": \"arial\",\n      fill: \"#999\",\n    });\n    this.datagroup\n    .attr({ transform: offset })\n    .selectAll(\"rect.data\").attr({\n      x: function(d,i) {\n        return that.xscale(d.week); },\n      y: function(d,i) { return d.day * (that.size + that.config.padding); },\n      width: that.size,\n      height: that.size,\n      fill: function(d,i) {\n        if(!that.config.empty && !d.value && typeof(d.value)==\"undefined\") return \"none\";\n        if(!d.value) return that.cscale(0);\n        return that.cscale(d.value);\n      }\n    });\n  }\n});"},"assets":[],"config":{"padding":{"name":"Padding","type":[{"name":"Number","level":3}],"default":10,"value":"3"},"margin":{"name":"Margin","type":[{"name":"Number","level":3}],"default":10,"value":10},"fontSize":{"name":"Font Size","type":[{"name":"Number","level":3}],"default":12,"value":"12"},"color":{"name":"Color","type":[{"name":"Color","level":4,"default":"#dc4521","Gray":"#cccccc","Positive":"#4c4","Negative":"#c44","subtype":{"negative":"negative","positive":"positive"}}],"default":"#dc4521","value":"#dc4521"},"today":{"name":"from Today","type":[{"name":"Boolean","level":2}],"default":true,"rebindOnChange":true,"value":true},"empty":{"name":"empty as 0","type":[{"name":"Boolean","level":2}],"default":true,"value":true}},"dimension":{"value":{"type":[{"name":"Number","level":3}],"require":true,"desc":"color","fields":[]},"date":{"type":[{"name":"Date","level":2,"match":{"type1":{},"type2":{},"type3":{},"type4":{}}}],"require":true,"desc":"date","fields":[]}},"dimlen":2,"createdtime":"2016-05-22T23:52:44.000Z","modifiedtime":"2016-05-31T02:03:13.000Z","data":[]}